#!/bin/bash

echo ""
echo "Running pre-commit checks..."
echo "================================"
echo ""

# Get modified Kotlin files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACMR | grep "\.kt$")

if [ -z "$STAGED_FILES" ]; then
    echo "No Kotlin files to check"
    exit 0
fi

echo "Kotlin files to check:"
echo "$STAGED_FILES"
echo ""

# Format code with Spotless
echo "Formatting code with spotlessApply..."
./gradlew spotlessApply --daemon

SPOTLESS_STATUS=$?

if [ $SPOTLESS_STATUS -ne 0 ]; then
    echo ""
    echo "Spotless formatting failed!"
    echo "Fix the errors and try again."
    exit 1
fi

# Add formatted changes to the commit
echo ""
echo "Code formatted successfully"
echo "Adding formatted files to commit..."

for FILE in $STAGED_FILES; do
    if [ -f "$FILE" ]; then
        git add "$FILE"
    fi
done

echo ""
echo "Pre-commit checks passed!"
echo ""

exit 0
